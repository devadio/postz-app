FROM node:22.20-alpine

ARG NEXT_PUBLIC_VERSION
ARG NEXT_PUBLIC_IS_GENERAL
ARG NEXT_PUBLIC_BACKEND_URL
ARG FRONTEND_URL
ARG BUILD_DATE
ARG CACHE_BUST_TOKEN

ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION
ENV NEXT_PUBLIC_IS_GENERAL=$NEXT_PUBLIC_IS_GENERAL
ENV NEXT_PUBLIC_BACKEND_URL=$NEXT_PUBLIC_BACKEND_URL
ENV FRONTEND_URL=$FRONTEND_URL
ENV BUILD_DATE=$BUILD_DATE
ENV CACHE_BUST_TOKEN=$CACHE_BUST_TOKEN

# Install system deps
RUN apk add --no-cache g++ make py3-pip bash nginx
RUN adduser -D -g 'www' www && mkdir /www && \
    chown -R www:www /var/lib/nginx && chown -R www:www /www
RUN npm --no-update-notifier --no-fund --global install pnpm@10.6.1 pm2

WORKDIR /app

# === CACHE LAYER START ===
# 1. Copy only dependency definitions
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# 2. Install dependencies BUT ignore scripts (prevents Prisma error)
# This layer will be CACHED unless package.json changes
RUN pnpm install --no-frozen-lockfile --ignore-scripts
# === CACHE LAYER END ===

# 3. Copy source code (files usually change here)
COPY . /app

# 4. Copy Nginx config
COPY var/docker/nginx.conf /etc/nginx/nginx.conf

# 5. Link workspace and run postinstall scripts (Prisma generate)
# This runs fast because dependencies are already downloaded
RUN pnpm install --no-frozen-lockfile

# 6. Build
RUN NODE_OPTIONS="--max-old-space-size=4096" pnpm run build

EXPOSE 3000
CMD ["sh", "-c", "nginx && pnpm run pm2"]
