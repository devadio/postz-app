FROM node:22.20-alpine

# Build arguments
ARG NEXT_PUBLIC_VERSION
ARG NEXT_PUBLIC_IS_GENERAL
ARG NEXT_PUBLIC_BACKEND_URL
ARG FRONTEND_URL

ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION
ENV NEXT_PUBLIC_IS_GENERAL=$NEXT_PUBLIC_IS_GENERAL
ENV NEXT_PUBLIC_BACKEND_URL=$NEXT_PUBLIC_BACKEND_URL
ENV FRONTEND_URL=$FRONTEND_URL

# Install system dependencies
RUN apk add --no-cache g++ make py3-pip bash nginx

# Setup nginx user
RUN adduser -D -g 'www' www && \
    mkdir /www && \
    chown -R www:www /var/lib/nginx && \
    chown -R www:www /www

# Install global Node packages
RUN npm --no-update-notifier --no-fund --global install pnpm@10.6.1 pm2

WORKDIR /app

# OPTIMIZATION: Copy package files first (these change rarely)
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Install dependencies (this layer will be cached if package files don't change)
RUN pnpm install --frozen-lockfile

# Copy nginx config
COPY var/docker/nginx.conf /etc/nginx/nginx.conf

# OPTIMIZATION: Copy source code last (this changes frequently)
COPY . /app

# Build application
RUN NODE_OPTIONS="--max-old-space-size=4096" pnpm run build

# Expose port
EXPOSE 3000

# Start services
CMD ["sh", "-c", "nginx && pnpm run pm2"]
